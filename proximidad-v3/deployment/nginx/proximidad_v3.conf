# ============================================
# NGINX Configuration for ProXimidad V3
# ============================================
# Ubicación: /etc/nginx/sites-available/proximidad_v3
# Symlink: sudo ln -s /etc/nginx/sites-available/proximidad_v3 /etc/nginx/sites-enabled/

# ============================================
# UPSTREAM BACKENDS - DOS APLICACIONES DJANGO
# ============================================

# App 1: API Pública (Servicios, Categorías, Usuarios, Comentarios, Favoritos)
upstream proximidad_app1 {
    server 127.0.0.1:8000 max_fails=3 fail_timeout=30s;
}

# App 2: API Privada (Solicitudes, Proveedor, Contacto)
upstream proximidad_app2 {
    server 127.0.0.1:8001 max_fails=3 fail_timeout=30s;
}

# ============================================
# SERVIDOR PRINCIPAL
# ============================================

server {
    listen 80;
    listen [::]:80;

    # Dominios y IPs permitidos
    server_name proximidad.serveirc.com 
                192.168.1.50 
                181.135.64.177 
                localhost;

    # Límites de carga
    client_max_body_size 10M;
    client_body_timeout 60s;

    # Logs
    access_log /var/log/nginx/proximidad_access.log;
    error_log /var/log/nginx/proximidad_error.log warn;

    # ============================================
    # ARCHIVOS ESTÁTICOS Y MEDIA
    # ============================================

    location /static/ {
        alias /home/proximidad/backend/staticfiles/;
        expires 30d;
        add_header Cache-Control "public, immutable";
        access_log off;
        
        # Tipos MIME
        types {
            text/css css;
            text/javascript js;
            application/json json;
            image/png png;
            image/jpeg jpg jpeg;
            image/svg+xml svg;
            font/woff woff;
            font/woff2 woff2;
        }
    }

    location /media/ {
        alias /home/proximidad/backend/media/;
        expires 7d;
        add_header Cache-Control "public";
        
        # Tipos MIME para imágenes
        types {
            image/png png;
            image/jpeg jpg jpeg;
            image/gif gif;
            image/webp webp;
        }
    }

    # ============================================
    # API ROUTING - APP 1 (Pública)
    # ============================================

    location ~ ^/api/(servicios|categorias|usuarios|comentarios|favoritos|generar-codigo|verificar-codigo|crear-usuario|login|estadisticas|v2) {
        proxy_pass http://proximidad_app1;
        
        # Headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        # Buffer
        proxy_buffering off;
        proxy_request_buffering off;
    }

    # ============================================
    # API ROUTING - APP 2 (Privada + Contacto)
    # ============================================

    # Primero las rutas exactas con barra final
    location /api/contacto/ {
        proxy_pass http://proximidad_app2;
        
        # Headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        # Buffer
        proxy_buffering off;
        proxy_request_buffering off;
    }

    # Luego las rutas con regex para solicitudes y proveedor
    location ~ ^/api/(solicitudes|proveedor) {
        proxy_pass http://proximidad_app2;
        
        # Headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        # Buffer
        proxy_buffering off;
        proxy_request_buffering off;
    }

    # ============================================
    # ADMIN DJANGO - APP 1
    # ============================================

    location /admin/ {
        proxy_pass http://proximidad_app1;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # ============================================
    # FRONTEND REACT (SPA)
    # ============================================

    location / {
        root /var/www/proximidad/frontend_build;
        try_files $uri $uri/ /index.html;
        
        # Headers de seguridad
        add_header X-Content-Type-Options nosniff;
        add_header X-Frame-Options SAMEORIGIN;
        add_header X-XSS-Protection "1; mode=block";
        
        # Cache para HTML: sin cache
        location ~* \.html$ {
            expires -1;
            add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate";
        }
        
        # Cache para assets
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }

    # ============================================
    # HEALTH CHECK
    # ============================================

    location /health {
        access_log off;
        return 200 "OK\n";
        add_header Content-Type text/plain;
    }

    # ============================================
    # SEGURIDAD
    # ============================================

    # Bloquear acceso a archivos ocultos
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }

    # Bloquear acceso a archivos sensibles
    location ~* \.(env|git|gitignore|htaccess|htpasswd)$ {
        deny all;
        access_log off;
        log_not_found off;
    }
}

# ============================================
# CONFIGURACIÓN DE OPTIMIZACIÓN
# ============================================

# Añadir en nginx.conf si no existe:
# 
# gzip on;
# gzip_vary on;
# gzip_proxied any;
# gzip_comp_level 6;
# gzip_types text/plain text/css text/xml text/javascript 
#            application/json application/javascript application/xml+rss 
#            application/rss+xml font/truetype font/opentype 
#            application/vnd.ms-fontobject image/svg+xml;
